# ML-сервис: Полная документация

## Обзор проекта

ML-сервис — это веб-приложение, позволяющее пользователям выполнять машинное обучение и предсказания с использованием предварительно обученных моделей. Проект состоит из двух основных компонентов:

1. **Бэкенд (FastAPI)** — API-сервер, который обрабатывает запросы, управляет моделями машинного обучения и базами данных.
2. **Фронтенд (Streamlit)** — пользовательский интерфейс, который взаимодействует с бэкендом для выполнения предсказаний.

## Структура проекта

```
ml-python/
├── main.py                # Основной файл FastAPI бэкенда
├── core/                  # Ядро приложения
│   ├── db.py              # Функции для работы с базой данных
│   ├── dto/               # Data Transfer Objects
│   │   ├── CreateAccountDto.py
│   │   ├── CreatePredictionDto.py
│   │   └── ...
│   └── model/             # Модели данных
│       └── ...
├── front/                 # Фронтенд приложения
│   └── app.py             # Streamlit приложение
├── model_lr.joblib        # Сохраненная модель линейной регрессии
├── model_rf.joblib        # Сохраненная модель случайного леса
├── model_cb.joblib        # Сохраненная модель CatBoost
├── config/                # Конфигурационные файлы
│   └── settings.py        # Настройки приложения
└── sample_data.csv        # Пример данных для предсказаний
```

## Технологии

Проект использует следующие технологии:

- **FastAPI**: Современный Python-фреймворк для создания API с поддержкой асинхронности
- **SQLite**: Легковесная база данных для хранения информации о пользователях, моделях и предсказаниях
- **Streamlit**: Python-библиотека для создания интерактивных веб-приложений
- **Pandas/NumPy**: Библиотеки для обработки данных
- **Joblib**: Библиотека для сериализации моделей машинного обучения
- **Threading**: Библиотека для асинхронного выполнения предсказаний

## Компоненты бэкенда (FastAPI)

### Модели данных (SQLite)

Бэкенд использует SQLite для хранения следующих данных:

- **users**: Информация о пользователях (id, имя, имя пользователя, пароль)
- **accounts**: Информация о балансе пользователей
- **models**: Информация о доступных моделях машинного обучения
- **predictions**: История предсказаний пользователей

### Схема базы данных

```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    firstname TEXT,
    username TEXT UNIQUE,
    password TEXT,
    created_at TEXT
);

CREATE TABLE accounts (
    id TEXT PRIMARY KEY,
    user_id TEXT UNIQUE,
    balance REAL,
    FOREIGN KEY(user_id) REFERENCES users(id)
);

CREATE TABLE models (
    id TEXT PRIMARY KEY,
    name TEXT,
    cost REAL,
    description TEXT,
    file_name TEXT -- Связь с файлом модели (lr, rf, cb)
);

CREATE TABLE predictions (
    id TEXT PRIMARY KEY,
    model_id TEXT,
    user_id TEXT,
    input_data TEXT,    -- JSON-строка с входными данными
    output_data TEXT,   -- JSON-строка с результатами
    status TEXT,        -- Статус (pending, completed, failed)
    created_at TEXT,
    updated_at TEXT,
    FOREIGN KEY(model_id) REFERENCES models(id),
    FOREIGN KEY(user_id) REFERENCES users(id)
);
```

### API эндпоинты

#### Аутентификация и управление пользователями

- **POST /users** - Регистрация нового пользователя
  - Body: `{ "firstname": "string", "username": "string", "password": "string" }`
  - Response: `{ "user_id": "string", "message": "string" }`

- **GET /users/me** - Получение информации о текущем пользователе (требует Basic Auth)
  - Response: `{ "user_id": "string", "firstname": "string", "username": "string", "balance": number }`

#### Управление балансом

- **POST /account/topup** - Пополнение баланса
  - Body: `{ "amount": number }`
  - Response: `{ "message": "string" }`

#### Модели и предсказания

- **GET /models** - Получение списка всех доступных моделей
  - Response: `[{ "id": "string", "name": "string", "cost": number, "description": "string" }]`

- **POST /predict** - Создание нового предсказания
  - Body: `{ "model_id": "string", "input_data": object or array }`
  - Response: `{ "prediction_id": "string", "status": "string", "message": "string" }`

- **GET /predict/{prediction_id}** - Получение результатов предсказания
  - Response: Зависит от статуса, включает данные входные/выходные и ссылку на CSV

- **GET /predict/{prediction_id}/download** - Скачивание результатов предсказания в формате CSV

- **GET /predictions** - Получение списка всех предсказаний пользователя
  - Response: `[{ "id": "string", "model_id": "string", "status": "string", "created_at": "string" }]`

### Процесс обработки предсказаний

1. Пользователь отправляет запрос с входными данными и ID модели
2. Система проверяет баланс пользователя и списывает средства
3. Создаётся запись предсказания со статусом "pending"
4. Запускается фоновый поток для асинхронной обработки предсказания
5. Пользователю возвращается ID предсказания
6. Фоновый поток:
   - Добавляет случайную задержку от 10 до 25 секунд
   - Обрабатывает данные и выполняет предсказание 
   - Обновляет запись в базе данных (статус "completed" или "failed")
   - Сохраняет результаты в формате JSON и CSV

## Фронтенд (Streamlit)

### Основные страницы

- **Страница входа**: Позволяет пользователям войти в систему
- **Страница регистрации**: Позволяет новым пользователям создать аккаунт
- **Дашборд**: Основная страница для авторизованных пользователей
  - Раздел баланса: Информация о текущем балансе и возможность пополнения
  - Раздел моделей: Список доступных моделей
  - Форма предсказания: Интерфейс для отправки запросов на предсказание
  - История предсказаний: Список предыдущих предсказаний с возможностью просмотра результатов

### Функциональность

- **Ввод данных**: Поддерживается как ручной ввод в формате JSON, так и загрузка CSV файлов
- **Предсказания**: Отправка запросов на предсказание с выбранной моделью
- **Просмотр результатов**: Интерактивный просмотр результатов предсказаний
- **Скачивание CSV**: Возможность скачивания результатов в формате CSV

## Машинное обучение

### Доступные модели

1. **Risk Assessment Model (lr)**: Использует линейную регрессию для оценки рисков
   - Стоимость: $10 за предсказание
   - Файл: model_lr.joblib

2. **Return Prediction Model (rf)**: Использует случайный лес для прогнозирования доходности
   - Стоимость: $15 за предсказание
   - Файл: model_rf.joblib

3. **Premium Analysis Model (cb)**: Использует CatBoost для продвинутого анализа инвестиций
   - Стоимость: $20 за предсказание
   - Файл: model_cb.joblib

### Формат данных

Все модели принимают данные в следующем формате:
- **Входные данные**: JSON-объект или массив объектов со свойствами feature_0, feature_1, feature_2, feature_3, feature_4
- **Выходные данные**: Массив предсказанных значений, точность модели и данные для CSV

Пример входных данных:
```json
{
  "feature_0": 0.1,
  "feature_1": 0.2,
  "feature_2": 0.3,
  "feature_3": 0.4,
  "feature_4": 0.5
}
```

## Запуск проекта

### Требования

- Python 3.8 или выше
- Зависимости из requirements.txt

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Запуск бэкенда

```bash
uvicorn main:app --reload
```

Бэкенд будет доступен по адресу: http://127.0.0.1:8000

### Запуск фронтенда

```bash
cd front
streamlit run app.py
```

Фронтенд будет доступен по адресу: http://localhost:8501

## Использование системы

### Регистрация и вход

1. Перейдите на страницу фронтенда (http://localhost:8501)
2. Нажмите "Go to Register" для создания нового аккаунта
3. Введите имя, имя пользователя и пароль
4. После успешной регистрации войдите в систему

### Пополнение баланса

1. На дашборде разверните секцию "💳 Top Up Balance"
2. Введите сумму пополнения
3. Нажмите "Top Up Now"

### Выполнение предсказания

1. В разделе "📊 Make a Prediction" выберите модель
2. Введите данные в формате JSON или загрузите CSV файл
3. Нажмите "Submit Prediction"
4. Дождитесь завершения обработки предсказания (10-25 секунд)
5. Просмотрите результаты в разделе "Prediction History"

### Просмотр результатов

1. В разделе "🕒 Prediction History" найдите нужное предсказание
2. Нажмите "View Details" для просмотра подробной информации
3. Для завершённых предсказаний доступна кнопка скачивания CSV

## Администрирование

### Добавление новых моделей

Чтобы добавить новую модель в систему:

1. Подготовьте и сохраните модель в формате joblib
2. Разместите файл модели в корневой папке проекта
3. Добавьте информацию о модели в базу данных
4. Обновите код в lifespan функции для загрузки модели

Пример кода для добавления новой модели:
```python
await create_model(
    "Новая модель",
    25.0,               # Стоимость
    "Описание модели",
    "model_filename"    # Имя файла без расширения
)
```

### Мониторинг системы

Система использует стандартное логирование Python. Логи выводятся в консоль при запуске бэкенда.

## Дополнительная информация

### Обработка ошибок

Система имеет следующие механизмы обработки ошибок:
- Проверка баланса перед выполнением предсказания
- Валидация входных данных
- Обработка ошибок при выполнении предсказаний
- Повторные попытки при проверке статуса

### Статусы предсказаний

- **pending**: Предсказание находится в процессе обработки
- **completed**: Предсказание успешно завершено
- **failed**: Произошла ошибка при выполнении предсказания

### Обновление статуса предсказаний

Система предусматривает только ручное обновление статуса предсказаний. Функциональность автоматического обновления (auto-refresh) была намеренно исключена по следующим причинам:

1. **Проблемы с синхронизацией**: Имелись несоответствия между статусами предсказаний в общем списке и их реальными статусами в базе данных.
2. **Нестабильная работа**: При автоматическом обновлении страницы возникали ситуации, когда уже завершенные предсказания все еще показывались как ожидающие (pending).
3. **Излишняя нагрузка на сервер**: Частые автоматические запросы к API создавали дополнительную нагрузку на сервер, что могло влиять на общую производительность системы.

Вместо этого, для получения актуального статуса предсказаний, пользователям предлагается использовать кнопку "Refresh Predictions". Это решение обеспечивает более надежное отображение актуальных статусов и предотвращает возможные проблемы, связанные с асинхронной обработкой предсказаний.

### Безопасность

Система использует Basic Authentication для аутентификации пользователей. В продакшн-окружении рекомендуется:
- Использовать HTTPS
- Хешировать пароли пользователей
- Добавить механизм защиты от брутфорс-атак

## Развитие проекта

### Возможные улучшения

1. **Аутентификация**: Использование JWT-токенов вместо Basic Auth
2. **Защита данных**: Хеширование паролей и шифрование чувствительной информации
3. **Масштабирование**: Переход на более мощную базу данных (PostgreSQL, MySQL)
4. **Мониторинг**: Добавление системы мониторинга и оповещений
5. **Пользовательский интерфейс**: Улучшение UX/UI, добавление визуализаций для результатов
6. **Документация API**: Добавление Swagger UI для автоматической документации API
7. **CI/CD**: Настройка непрерывной интеграции и доставки

## Заключение

ML-сервис предоставляет удобный интерфейс для выполнения предсказаний с использованием различных моделей машинного обучения. Система обладает всеми необходимыми компонентами для функционирования в рабочей среде, включая аутентификацию, учет баланса, асинхронную обработку и мониторинг.

Благодаря модульной архитектуре, система может быть легко расширена для поддержки дополнительных моделей, функций и интеграций. 